<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</title>

  <style>
  * { box-sizing: border-box; }

  body {
    font-family: Arial, sans-serif;
    min-height: 100vh;
    margin: 0;
    padding: 24px;
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.06), transparent 40%),
      linear-gradient(180deg, #2b235a 0%, #1b2b4a 100%);
  }

 body::before {
  content: "";
  position: fixed;
  inset: 0;
  background:
    radial-gradient(circle at 85% 15%, rgba(0,0,0,0.04), transparent 30%),
    radial-gradient(circle at 15% 85%, rgba(0,0,0,0.03), transparent 35%);
  pointer-events: none;
}


  .card {
    max-width: 520px;
    margin: auto;
    background: #fff;
    padding: 26px 24px 28px;
    border-radius: 18px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.08);
  }

  /* ===== HEADER ===== */
  .header {
    text-align: center;
    margin-bottom: 26px;
    position: relative;
  }

  .logo {
  width: 90px;
  margin-bottom: 8px;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,.15));
}

  .titleMain {
    font-size: 20px;
    font-weight: bold;
    color: #1f1f1f;
    margin-bottom: 6px;
  }

  .titleSub {
    font-size: 16px;
    color: #555;
    margin-bottom: 4px;
  }

  .titleYear {
    font-size: 14px;
    color: #777;
  }

  .divider {
  width: 60px;
  height: 2px;
  margin: 12px auto 0;
  border-radius: 10px;
  background: linear-gradient(
    to right,
    transparent,
    #d6b15e,
    transparent
  );
}


  /* ===== FORM ===== */
  label {
  display: block;
  margin-top: 14px;
  margin-bottom: 6px;
  font-weight: bold;
  font-size: 14px;   /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
  color: #333;       /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
}

input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 15px;
  outline: none;
  background: #fafafa;  /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
}


  input:focus {
    border-color: #6c63ff;
    box-shadow: 0 0 0 3px rgba(108,99,255,.12);
  }

  button {
  margin-top: 22px;
  width: 100%;
  padding: 14px;
  font-size: 16px;
  font-weight: bold;
  background: #6c63ff;
  color: #fff;
  border: none;
  border-radius: 12px;
  cursor: pointer;

  transition: all .25s ease;   /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
}

button:hover:not(:disabled) {
  background: #5a54e6;         /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
  transform: translateY(-1px); /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
  box-shadow: 0 6px 14px rgba(0,0,0,.15); /* ğŸ‘ˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
}

button:disabled {
  opacity: .65;
  cursor: not-allowed;
}


  .msg {
    margin-top: 14px;
    padding: 12px;
    border-radius: 12px;
    display: none;
    text-align: center;
    font-weight: bold;
  }

  .ok { background: #e8fff0; color: #0f6b2f; }
  .bad { background: #ffecec; color: #8a1f1f; }

  /* ğŸŒ™ Ramadan Decoration */
.ramadan-decor {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  margin-bottom: 16px;
}

.ramadan-decor::before,
.ramadan-decor::after {
  content: "";
  width: 60px;
  height: 1px;
  background: linear-gradient(to right, transparent, #d4af37, transparent);
}

.ramadan-icon {
  font-size: 18px;
  color: #d4af37;
  opacity: 0.9;
}


</style>

</head>

<body>

  <div class="card">
<!-- ğŸŒ™ Ramadan Decoration -->
  <div class="ramadan-decor">
    <span class="ramadan-icon">ğŸŒ™ âœ¨</span>
  </div>
    <!-- âœ… NEW HEADER -->
    <div class="header">
  <img src="1.png" class="logo" alt="Ø´Ø¹Ø§Ø± Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„ÙØ­ÙŠØ­ÙŠÙ„ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠØ©">

  <div class="titleMain">Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„ÙØ­ÙŠØ­ÙŠÙ„ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠØ©</div>
  <div class="titleSub">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ© Ù„Ø´Ù‡Ø± Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</div>
  <div class="titleYear">1447Ù‡Ù€ â€“ 2026Ù…</div>

  <div class="divider"></div>
</div>
<form id="regForm">
      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="name" autocomplete="name" />

      <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
      <input id="civil_id" inputmode="numeric" />

      <label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
      <input id="box_number" inputmode="numeric" />

      <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
      <input id="phone" inputmode="numeric" maxlength="8" autocomplete="tel" />

      <button id="btnSubmit" type="submit">ØªØ³Ø¬ÙŠÙ„</button>
    </form>

    <div id="msg" class="msg"></div>

    <!-- âœ… Ø²Ø± Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙˆÙ„Ù… ÙŠØ±Ø³Ù„ÙˆØ§ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª) -->
    <button id="goQuizBtn" type="button" style="display:none; margin-top:12px; background:#1f8b4c;">
      Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
    </button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwhdO_Ye6WivgCQyMTgEHrvNQOuEv6RJ9qBLCy-Vrhv_6BUhiCMV_m9kv82V3nYebk/exec";

    const form = document.getElementById("regForm");
    const msg  = document.getElementById("msg");
    const btn  = document.getElementById("btnSubmit");
    const goBtn = document.getElementById("goQuizBtn");

    const $ = (id) => document.getElementById(id);

    function showMsg(ok, text){
      msg.style.display = "block";
      msg.className = "msg " + (ok ? "ok" : "bad");
      msg.textContent = text;
    }

    function hideMsg(){
      msg.style.display = "none";
    }

    function digits(v){
      return String(v ?? "").replace(/[^\d]/g, "");
    }

    function getParam(name){
      const u = new URL(window.location.href);
      return (u.searchParams.get(name) || "").trim();
    }

    async function apiCall(bodyObj){
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(bodyObj)
      });
      return await res.json();
    }

    function showGoToQuizButton(civil_id, box_number){
      const civ = encodeURIComponent(civil_id);
      const box = encodeURIComponent(box_number);
      const target = `quiz.html?civil_id=${civ}&box_number=${box}`;

      goBtn.style.display = "block";
      goBtn.textContent = "Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©";
      goBtn.onclick = () => window.location.href = target;
    }

    // ===============================
    // Auto-fill from login/quiz link
    // ===============================
    (function autofillFromLink(){
      const civil = digits(getParam("civil_id"));
      const box   = digits(getParam("box_number"));

      const civilEl = $("civil_id");
      const boxEl   = $("box_number");

      if (civil && civilEl) civilEl.value = civil;
      if (box && boxEl)     boxEl.value = box;

      // âœ… Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† Ù„ÙŠÙ†Ùƒ Ù†Ø®Ù„ÙŠÙ‡Ù… ØºÙŠØ± Ù‚Ø§Ø¨Ù„ÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      if (civil && box && civilEl && boxEl) {
        civilEl.readOnly = true;
        boxEl.readOnly = true;
      }
    })();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMsg();
      goBtn.style.display = "none";

      const payload = {
        action: "register",
        name: ($("name").value || "").trim(),
        civil_id: digits(($("civil_id").value || "").trim()),
        box_number: digits(($("box_number").value || "").trim()),
        phone: digits(($("phone").value || "").trim())
      };

      if (!payload.name || !payload.civil_id || !payload.box_number || !payload.phone) {
        showMsg(false, "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        return;
      }

      // âœ… ØªØ­Ù‚Ù‚ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ 8 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
      if (payload.phone.length !== 8) {
        showMsg(false, "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 8 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";

      try {
        const data = await apiCall(payload);
        console.log("API BUILD =", data.build);

        // âœ… Ø±Ø³Ø§Ø¦Ù„ Ø°ÙƒÙŠØ©
        if (data.ok) {
          showMsg(true, "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ… Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†Ù...");

          showGoToQuizButton(payload.civil_id, payload.box_number);

          setTimeout(() => {
            goBtn.click();
          }, 2000);

          return;
        }

        const map = {
          ALREADY_REGISTERED: "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚. (Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)",
          PHONE_EXISTS: "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.",
          NOT_ALLOWED: "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„Ø³Ø¬Ù„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.",
          MISSING_FIELDS: "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.",
          BAD_KEYS: "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.",
          SHEETS_NOT_FOUND: "ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.",
          SERVER_ERROR: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
        };

        if (data.code === "ALREADY_REGISTERED") {
          const access = await apiCall({
            action: "checkAccess",
            civil_id: payload.civil_id,
            box_number: payload.box_number
          });

          if (access.ok) {
            showMsg(true, "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¢Ù†.");
            showGoToQuizButton(payload.civil_id, payload.box_number);
          } else {
            showMsg(false, access.message || "ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…Ø´Ø§Ø±ÙƒØªÙƒ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            goBtn.style.display = "none";
          }
          return;
        }

        showMsg(false, map[data.code] || data.message || "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");

      } catch (err) {
        showMsg(false, "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = "ØªØ³Ø¬ÙŠÙ„";
      }
    });
  </script>

</body>
</html>
